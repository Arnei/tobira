(()=>{"use strict";var e={152:function(e,t,o){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:true});t.runServer=void 0;const s=r(o(685));const n=r(o(477));const i=o(837);const runServer=async e=>new Promise(((t,o)=>{var r;const n=(r=e.listen)!==null&&r!==void 0?r:{host:"127.0.0.1",port:3091};const i=s.default.createServer(((t,o)=>{listener(t,o,e).then((()=>o.end())).catch((e=>{if(e instanceof ErrorResponse){o.writeHead(e.code);if(e.body){o.write(e.body)}}else{o.writeHead(l.INTERNAL_SERVER_ERROR);o.write("Internal server error")}o.end()}))}));i.on("listening",(()=>{if(e.onListen==null){console.log("Listening on: ",n)}else{e.onListen()}}));i.on("error",o);i.on("close",t);if("socketPath"in n){i.listen(n.socketPath)}else{i.listen(n.port,n.host)}}));t.runServer=runServer;const a="userid";const c="password";class ErrorResponse{constructor(e,t){this.code=e;this.body=t}}const listener=async(e,t,{check:o,tobira:r})=>{var u;if(e.method!=="POST"){throw new ErrorResponse(l.METHOD_NOT_ALLOWED)}if(!((u=e.headers["content-type"])===null||u===void 0?void 0:u.startsWith("application/x-www-form-urlencoded"))){throw new ErrorResponse(l.BAD_REQUEST,"incorrect content type")}const d=await downloadBody(e);const _=new i.TextDecoder("utf8",{fatal:true});let p;try{p=_.decode(d)}catch(e){throw new ErrorResponse(l.BAD_REQUEST,"Request body is not valid UTF-8")}const E=n.default.parse(p);const[R,f]=[a,c].map((e=>{const t=E[e];if(typeof t==="string"){return t}else{if((t===null||t===void 0?void 0:t.length)!==1){throw new ErrorResponse(l.BAD_REQUEST,`field ${e} not present exactly once`)}return t[0]}}));let h;try{h=await o({userid:R,password:f})}catch(e){console.error("Login check threw an exception: ",e);t.writeHead(l.INTERNAL_SERVER_ERROR);return}if(h==="forbidden"){t.writeHead(l.FORBIDDEN)}else{const{username:e,displayName:o,roles:n}=h;const b64encode=e=>Buffer.from(e).toString("base64");let i;try{i=await new Promise(((t,i)=>{const a={...r!==null&&r!==void 0?r:{host:"localhost",port:3080},path:"/~session",method:"POST",headers:{"x-tobira-username":b64encode(e),"x-tobira-user-display-name":b64encode(o),"x-tobira-user-roles":b64encode(n.join(","))}};const c=s.default.request(a);c.on("response",t);c.on("error",i);c.end()}))}catch(e){console.error("Failed to create user session:",e);t.writeHead(l.BAD_GATEWAY);return}if(i.statusCode!==l.NO_CONTENT){console.warn("unexpected status code from 'POST /~session'")}t.writeHead(l.NO_CONTENT,{"set-cookie":i.headers["set-cookie"]})}};const downloadBody=async e=>new Promise(((t,o)=>{const r=[];e.on("data",(e=>r.push(e)));e.on("end",(()=>t(Buffer.concat(r))));e.on("error",o)}));const l={NO_CONTENT:204,BAD_REQUEST:400,FORBIDDEN:403,METHOD_NOT_ALLOWED:405,INTERNAL_SERVER_ERROR:500,BAD_GATEWAY:502}},177:function(e,t,o){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:true});const s=r(o(292));const n=o(152);const main=async()=>{let e;let t;if(process.argv[2]){const o=process.argv[2];const r=`/opt/tobira/${o}/socket/auth.sock`;const n=`/opt/tobira/${o}/socket/tobira.sock`;await s.default.rm(r,{force:true});e={socketPath:r};t={socketPath:n}}else{e={host:"0.0.0.0",port:3091};t={host:"host.docker.internal",port:3080}}process.on("SIGTERM",(()=>process.exit(0)));try{await(0,n.runServer)({listen:e,tobira:t,check:check,onListen:()=>{console.log("Listening on:",e);if("socketPath"in e){s.default.chmod(e.socketPath,511).catch((e=>console.warn("could not chmod socket file",e)))}}})}catch(e){console.log(e)}};const check=async({userid:e,password:t})=>{const o=a[e];return t===i&&o?{username:e,displayName:o.displayName,roles:o.roles}:"forbidden"};const i="tobira";const a={admin:{displayName:"Administrator",roles:["ROLE_ADMIN","ROLE_USER_ADMIN","ROLE_ANONYMOUS","ROLE_USER","ROLE_SUDO"]},sabine:{displayName:"Sabine Rudolfs",roles:["ROLE_USER_SABINE","ROLE_ANONYMOUS","ROLE_USER","ROLE_INSTRUCTOR","ROLE_TOBIRA_MODERATOR"]},augustus:{displayName:"Augustus PagenkÃ¤mper",roles:["ROLE_USER_AUGUSTUS","ROLE_ANONYMOUS","ROLE_USER","ROLE_STUDENT"]}};main()},292:e=>{e.exports=require("fs/promises")},685:e=>{e.exports=require("http")},477:e=>{e.exports=require("querystring")},837:e=>{e.exports=require("util")}};var t={};function __nccwpck_require__(o){var r=t[o];if(r!==undefined){return r.exports}var s=t[o]={exports:{}};var n=true;try{e[o].call(s.exports,s,s.exports,__nccwpck_require__);n=false}finally{if(n)delete t[o]}return s.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var o=__nccwpck_require__(177);module.exports=o})();