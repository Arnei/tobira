(()=>{"use strict";var e={152:function(e,r,o){var t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:true});r.runLoginProxyServer=r.runLoginCallbackServer=void 0;const s=t(o(685));const n=t(o(477));const i=o(837);const runServerImpl=async(e,r)=>new Promise(((o,t)=>{const n=s.default.createServer(((e,o)=>{r(e,o).then((()=>o.end())).catch((e=>{if(e instanceof ErrorResponse){o.writeHead(e.code);if(e.body){o.write(e.body)}}else{o.writeHead(l.INTERNAL_SERVER_ERROR);o.write("Internal server error")}o.end()}))}));n.on("listening",(()=>{if(e.onListen==null){console.log("Listening on: ",e.listen)}else{e.onListen()}}));n.on("error",t);n.on("close",o);if("socketPath"in e.listen){n.listen(e.listen.socketPath)}else{n.listen(e.listen.port,e.listen.host)}}));class ErrorResponse{constructor(e,r){this.code=e;this.body=r}}const runLoginCallbackServer=async e=>runServerImpl(e,((r,o)=>loginCallbackHandler(r,o,e)));r.runLoginCallbackServer=runLoginCallbackServer;const loginCallbackHandler=async(e,r,{check:o})=>{var t;if(e.method!=="POST"){throw new ErrorResponse(l.METHOD_NOT_ALLOWED)}if(!((t=e.headers["content-type"])===null||t===void 0?void 0:t.startsWith("application/json"))){throw new ErrorResponse(l.BAD_REQUEST,"incorrect content type")}const s=await downloadBody(e);let n;let i;try{const e=JSON.parse(s);n=e["userid"];i=e["password"]}catch(e){throw new ErrorResponse(l.BAD_REQUEST,"Invalid JSON request body")}if(n==null||i==null){throw new ErrorResponse(l.BAD_REQUEST,"Missing fields in body")}let a;try{a=await o({userid:n,password:i})}catch(e){console.error("Login check threw an exception: ",e);r.writeHead(l.INTERNAL_SERVER_ERROR);return}r.writeHead(200,{"Content-Type":"application/json"});if(a==="forbidden"){r.end(JSON.stringify({outcome:"no-user"}))}else{r.end(JSON.stringify({outcome:"user",...a}))}};const runLoginProxyServer=async e=>runServerImpl(e,((r,o)=>loginProxyHandler(r,o,e)));r.runLoginProxyServer=runLoginProxyServer;const a="userid";const c="password";const loginProxyHandler=async(e,r,{check:o,tobira:t})=>{var i;if(e.method!=="POST"){throw new ErrorResponse(l.METHOD_NOT_ALLOWED)}if(!((i=e.headers["content-type"])===null||i===void 0?void 0:i.startsWith("application/x-www-form-urlencoded"))){throw new ErrorResponse(l.BAD_REQUEST,"incorrect content type")}const d=await downloadBody(e);const u=n.default.parse(d);const[_,R]=[a,c].map((e=>{const r=u[e];if(typeof r==="string"){return r}else{if((r===null||r===void 0?void 0:r.length)!==1){throw new ErrorResponse(l.BAD_REQUEST,`field ${e} not present exactly once`)}return r[0]}}));let E;try{E=await o({userid:_,password:R})}catch(e){console.error("Login check threw an exception: ",e);r.writeHead(l.INTERNAL_SERVER_ERROR);return}if(E==="forbidden"){r.writeHead(l.FORBIDDEN)}else{const{username:e,displayName:o,roles:n,userRole:i,email:a}=E;n.push(i);const b64encode=e=>Buffer.from(e).toString("base64");let c;try{c=await new Promise(((r,i)=>{const c={...t!==null&&t!==void 0?t:{host:"localhost",port:3080},path:"/~session",method:"POST",headers:{"x-tobira-username":b64encode(e),"x-tobira-user-display-name":b64encode(o),"x-tobira-user-roles":b64encode(n.join(",")),...a&&{"x-tobira-user-email":b64encode(a)}}};const l=s.default.request(c);l.on("response",r);l.on("error",i);l.end()}))}catch(e){console.error("Failed to create user session:",e);r.writeHead(l.BAD_GATEWAY);return}if(c.statusCode!==l.NO_CONTENT){console.warn("unexpected status code from 'POST /~session'")}r.writeHead(l.NO_CONTENT,{"set-cookie":c.headers["set-cookie"]})}};const downloadBody=async e=>{const r=await new Promise(((r,o)=>{const t=[];e.on("data",(e=>t.push(e)));e.on("end",(()=>r(Buffer.concat(t))));e.on("error",o)}));const o=new i.TextDecoder("utf8",{fatal:true});try{return o.decode(r)}catch(e){throw new ErrorResponse(l.BAD_REQUEST,"Request body is not valid UTF-8")}};const l={NO_CONTENT:204,BAD_REQUEST:400,FORBIDDEN:403,METHOD_NOT_ALLOWED:405,INTERNAL_SERVER_ERROR:500,BAD_GATEWAY:502}},177:function(e,r,o){var t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:true});const s=t(o(292));const n=o(152);const main=async()=>{let e;if(process.argv[2]){const r=process.argv[2];const o=`/opt/tobira/${r}/socket/auth.sock`;await s.default.rm(o,{force:true});e={socketPath:o}}else{e={host:"0.0.0.0",port:3091}}process.on("SIGTERM",(()=>process.exit(0)));try{await(0,n.runLoginCallbackServer)({listen:e,check:check,onListen:()=>{console.log("Listening on:",e);if("socketPath"in e){s.default.chmod(e.socketPath,511).catch((e=>console.warn("could not chmod socket file",e)))}}})}catch(e){console.log(e)}};const check=async({userid:e,password:r})=>{const o=process.argv[2]&&e==="admin"?process.env.TOBIRA_ADMIN_PASSWORD:i;if(!o){console.error("Tobira admin password env not set!");return"forbidden"}const t=a[e];if(r===o&&t){return{username:e,displayName:t.displayName,userRole:t.userRole,roles:t.roles.concat(["ROLE_ANONYMOUS","ROLE_USER"]),email:t.email}}else{console.log(`Invalid login ${e}:${r}`);return"forbidden"}};const i="tobira";const a={admin:{displayName:"Administrator",userRole:"ROLE_USER_ADMIN",roles:["ROLE_ADMIN","ROLE_SUDO"],email:"admin@example.org"},sabine:{displayName:"Sabine Rudolfs",userRole:"ROLE_USER_SABINE",roles:["ROLE_INSTRUCTOR","ROLE_STAFF","ROLE_TOBIRA_MODERATOR"],email:"sabine@example.org"},"björk":{displayName:"Prof. Björk Guðmundsdóttir",userRole:"ROLE_USER_BJOERK",roles:["ROLE_EXTERNAL","ROLE_TOBIRA_MODERATOR"],email:"bjoerk@example.org"},morgan:{displayName:"Morgan Yu",userRole:"ROLE_USER_MORGAN",roles:["ROLE_STUDENT","ROLE_TOBIRA_UPLOAD"],email:"morgan@example.org"},jose:{displayName:"José Carreño Quiñones",userRole:"ROLE_USER_JOSE",roles:["ROLE_STUDENT"]}};main()},292:e=>{e.exports=require("fs/promises")},685:e=>{e.exports=require("http")},477:e=>{e.exports=require("querystring")},837:e=>{e.exports=require("util")}};var r={};function __nccwpck_require__(o){var t=r[o];if(t!==undefined){return t.exports}var s=r[o]={exports:{}};var n=true;try{e[o].call(s.exports,s,s.exports,__nccwpck_require__);n=false}finally{if(n)delete r[o]}return s.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var o=__nccwpck_require__(177);module.exports=o})();