(()=>{"use strict";var e={152:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:true});t.runServer=void 0;const s=o(r(685));const n=o(r(477));const a=r(837);const runServer=async e=>new Promise(((t,r)=>{const o=s.default.createServer(((t,r)=>{listener(t,r,e).then((()=>r.end())).catch((e=>{if(e instanceof ErrorResponse){r.writeHead(e.code);if(e.body){r.write(e.body)}}else{r.writeHead(l.INTERNAL_SERVER_ERROR);r.write("Internal server error")}r.end()}))}));o.on("listening",(()=>{var t;return(t=e.onListen)===null||t===void 0?void 0:t.call(e)}));o.on("error",r);o.on("close",t);if("socketPath"in e.listen){o.listen(e.listen.socketPath)}else{o.listen(e.listen.port,e.listen.host)}}));t.runServer=runServer;const i="userid";const c="password";class ErrorResponse{constructor(e,t){this.code=e;this.body=t}}const listener=async(e,t,{check:r,tobira:o})=>{var u;if(e.method!=="POST"){throw new ErrorResponse(l.METHOD_NOT_ALLOWED)}if(!((u=e.headers["content-type"])===null||u===void 0?void 0:u.startsWith("application/x-www-form-urlencoded"))){throw new ErrorResponse(l.BAD_REQUEST,"incorrect content type")}const d=await downloadBody(e);const _=new a.TextDecoder("utf8",{fatal:true});let p;try{p=_.decode(d)}catch(e){throw new ErrorResponse(l.BAD_REQUEST,"Request body is not valid UTF-8")}const E=n.default.parse(p);const[R,f]=[i,c].map((e=>{const t=E[e];if(typeof t==="string"){return t}else{if((t===null||t===void 0?void 0:t.length)!==1){throw new ErrorResponse(l.BAD_REQUEST,`field ${e} not present exactly once`)}return t[0]}}));let O;try{O=await r({userid:R,password:f})}catch(e){console.error("Login check threw an exception: ",e);t.writeHead(l.INTERNAL_SERVER_ERROR);return}if(O==="forbidden"){t.writeHead(l.FORBIDDEN)}else{const{username:e,displayName:r,roles:n}=O;const b64encode=e=>Buffer.from(e).toString("base64");let a;try{a=await new Promise(((t,a)=>{const i={...o!==null&&o!==void 0?o:{host:"localhost",port:3080},path:"/~session",method:"POST",headers:{"x-tobira-username":b64encode(e),"x-tobira-user-display-name":b64encode(r),"x-tobira-user-roles":b64encode(n.join(","))}};const c=s.default.request(i);c.on("response",t);c.on("error",a);c.end()}))}catch(e){console.error("Failed to create user session:",e);t.writeHead(l.BAD_GATEWAY);return}if(a.statusCode!==l.NO_CONTENT){console.warn("unexpected status code from 'POST /~session'")}t.writeHead(l.NO_CONTENT,{"set-cookie":a.headers["set-cookie"]})}};const downloadBody=async e=>new Promise(((t,r)=>{const o=[];e.on("data",(e=>o.push(e)));e.on("end",(()=>t(Buffer.concat(o))));e.on("error",r)}));const l={NO_CONTENT:204,BAD_REQUEST:400,FORBIDDEN:403,METHOD_NOT_ALLOWED:405,INTERNAL_SERVER_ERROR:500,BAD_GATEWAY:502}},177:function(e,t,r){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:true});const s=o(r(292));const n=r(152);const main=async()=>{let e;let t;if(process.argv[2]){const r=process.argv[2];const o=`/opt/tobira/${r}/socket/auth.sock`;const n=`/opt/tobira/${r}/socket/tobira.sock`;await s.default.rm(o,{force:true});e={socketPath:o};t={socketPath:n}}else{e={host:"0.0.0.0",port:3091};t={host:"host.docker.internal",port:3080}}process.on("SIGTERM",(()=>process.exit(0)));try{await(0,n.runServer)({listen:e,tobira:t,check:check,onListen:()=>{console.log("Listening on:",e);if("socketPath"in e){s.default.chmod(e.socketPath,511).catch((e=>console.warn("could not chmod socket file",e)))}}})}catch(e){console.log(e)}};const check=async({userid:e,password:t})=>{const r=i[e];return t===a&&r?{username:e,displayName:r.displayName,roles:r.roles}:"forbidden"};const a="tobira";const i={admin:{displayName:"Administrator",roles:["ROLE_ADMIN","ROLE_USER_ADMIN","ROLE_ANONYMOUS","ROLE_USER","ROLE_SUDO"]},sabine:{displayName:"Sabine Rudolfs",roles:["ROLE_USER_SABINE","ROLE_ANONYMOUS","ROLE_USER","ROLE_INSTRUCTOR","ROLE_TOBIRA_MODERATOR"]},augustus:{displayName:"Augustus PagenkÃ¤mper",roles:["ROLE_USER_AUGUSTUS","ROLE_ANONYMOUS","ROLE_USER","ROLE_STUDENT"]}};main()},292:e=>{e.exports=require("fs/promises")},685:e=>{e.exports=require("http")},477:e=>{e.exports=require("querystring")},837:e=>{e.exports=require("util")}};var t={};function __nccwpck_require__(r){var o=t[r];if(o!==undefined){return o.exports}var s=t[r]={exports:{}};var n=true;try{e[r].call(s.exports,s,s.exports,__nccwpck_require__);n=false}finally{if(n)delete t[r]}return s.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var r=__nccwpck_require__(177);module.exports=r})();